<meta name='viewport' content='width=device-width, initial-scale=1'/><!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Dungeon Prototype Expanded</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
/* ======================= */
/* GLOBAL + RESET */
/* ======================= */

* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: Arial, sans-serif;
    background: #000;
    overflow: hidden;
    user-select: none;
    touch-action: manipulation;
}
button {
    padding: 18px 28px;
    border: none;
    font-size: 22px;
    border-radius: 10px;
    background: rgba(255,255,255,0.15);
    color: #fff;
}
button:active { transform: scale(0.95); }

/* ======================= */
/* MENU SCREEN */
/* ======================= */

#menuScreen {
    position: absolute;
    width: 100%;
    height: 100%;
    background: url("https://images.unsplash.com/photo-1608874973303-e40b0e176b69") center/cover no-repeat;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    perspective: 1000px;
    z-index: 10;
}

#bigDoor {
    width: 60%;
    max-width: 500px;
    height: 70%;
    background: url("https://i.imgur.com/7PjPG2T.png") center/cover no-repeat;
    transform: rotateY(0deg);
    transition: 1.2s;
}

#playBtn {
    margin-top: 30px;
    background: linear-gradient(#c99,#733);
    border: 3px solid #400;
    font-weight: bold;
}

.door-open {
    transform: rotateY(-120deg);
}

/* ======================= */
/* GAME UI */
/* ======================= */

#gameScreen {
    position: absolute;
    width: 100%;
    height: 100%;
    display: none;
    background: #000;
    overflow: hidden;
}

/* Room background */
#roomBackground {
    position: absolute;
    width: 100%;
    height: 100%;
    background: url("https://images.unsplash.com/photo-1617196037157-4b0353d363df") center/cover no-repeat;
    filter: brightness(0.55);
}

/* Room content area */
#roomContainer {
    position: absolute;
    width: 100%;
    height: 100%;
    z-index: 2;
    padding: 20px;
    color: #fff;
}

/* Entity image */
#roomImage {
    width: 60%;
    margin: auto;
    margin-top: 40px;
    display: block;
    border-radius: 15px;
    border: 5px solid rgba(255,255,255,0.2);
}

/* Text box */
#logBox {
    width: 90%;
    margin: 0 auto;
    margin-top: 20px;
    min-height: 120px;
    padding: 15px;
    background: rgba(0,0,0,0.55);
    border: 2px solid rgba(255,255,255,0.2);
    border-radius: 10px;
    overflow-y: auto;
}

/* Buttons */
#controls {
    position: absolute;
    bottom: 20px;
    width: 100%;
    text-align: center;
}

/* Enemy / player stats */
#statsPanel {
    position: absolute;
    top: 0;
    width: 100%;
    padding: 10px;
    background: rgba(0,0,0,0.35);
    display: flex;
    justify-content: space-between;
}

.stat {
    background: rgba(0,0,0,0.45);
    padding: 10px 14px;
    border-radius: 8px;
}

/* NEXT ROOM BUTTON */
#nextRoomBtn {
    display: none;
    background: #3a3;
    font-size: 24px;
}

/* INVENTORY PANEL */
#inventoryBtn {
    position: absolute;
    right: 15px;
    bottom: 90px;
    background: #666;
}

#inventoryPanel {
    position: absolute;
    right: 10px;
    top: 60px;
    width: 40%;
    max-width: 240px;
    height: 55%;
    background: rgba(20,20,20,0.9);
    border: 2px solid #444;
    border-radius: 10px;
    padding: 10px;
    color: #fff;
    overflow-y: auto;
    display: none;
}

.itemBox {
    padding: 8px;
    background: rgba(255,255,255,0.05);
    border-bottom: 1px solid #555;
    margin-bottom: 6px;
}

</style>
</head>
<body>

<!-- =========================================================== -->
<!-- MENU -->
<!-- =========================================================== -->
<div id="menuScreen">
    <div id="bigDoor"></div>
    <button id="playBtn">PLAY</button>
</div>

<!-- =========================================================== -->
<!-- GAME -->
<!-- =========================================================== -->
<div id="gameScreen">

    <div id="roomBackground"></div>

    <div id="statsPanel">
        <div class="stat" id="playerStats"></div>
        <div class="stat" id="enemyStats"></div>
    </div>

    <img id="roomImage" src="" alt="object">

    <div id="roomContainer">
        <div id="logBox"></div>
    </div>

    <div id="controls">
        <button id="attackBtn">Атака</button>
        <button id="defBtn">Щит</button>
        <button id="dodgeBtn">Уклонение</button>
        <button id="nextRoomBtn">Дальше →</button>
        <button id="inventoryBtn">Инвентарь</button>
    </div>

    <div id="inventoryPanel"></div>

</div>

<!-- =========================================================== -->
<!-- JAVASCRIPT LOGIC -->
<!-- =========================================================== -->

<script>

/* ============================================================= */
/* ARCHITECTURE */
/*
    Core systems:
    - GameState: floor, room, enemy info
    - Player: stats, inventory
    - Room generator
    - Combat system
    - UI controller
    - Save / Load
*/
/* ============================================================= */


/* ============================= */
/* PLAYER */
/* ============================= */

let player = {
    hp: 100,
    maxHp: 100,
    dmg: 10,
    crit: 0.15,
    miss: 0.1,
    inventory: []
};


/* ============================= */
/* GAME STATE */
/* ============================= */

let game = {
    floor: 1,
    room: 1,
    currentEnemy: null,
    inCombat: false
};


/* ============================= */
/* ROOM GENERATOR */
/* ============================= */

const roomTypes = [
    "enemy",
    "chest",
    "light",
    "merchant",
    "trap",
    "empty"
];

const images = {
    enemy: "https://i.imgur.com/pBjKpGS.png",
    chest: "https://i.imgur.com/qZWXJbP.png",
    light: "https://i.imgur.com/xwsTqOa.png",
    merchant: "https://i.imgur.com/2xT2mSi.png",
    trap: "https://i.imgur.com/v6U7Vux.png",
    empty: "https://i.imgur.com/qsSbQb9.jpeg"
};

function generateRoom() {
    let t = roomTypes[Math.floor(Math.random()*roomTypes.length)];
    return t;
}


/* ============================= */
/* ENEMY GENERATOR */
/* ============================= */

function generateEnemy() {
    return {
        name: "Скелет",
        hp: 40 + game.floor * 4,
        dmg: 5 + game.floor * 2,
        crit: 0.1 + game.floor*0.01,
        miss: 0.1
    };
}


/* ============================= */
/* INVENTORY */
/* ============================= */

function addItem(item) {
    player.inventory.push(item);
    updateInventoryUI();
}

function updateInventoryUI() {
    let box = document.getElementById("inventoryPanel");
    box.innerHTML = `<h3>Инвентарь</h3>`;
    player.inventory.forEach(i=>{
        box.innerHTML += `<div class="itemBox">${i.name}</div>`;
    });
}


/* ============================= */
/* SAVE / LOAD */
/* ============================= */

function saveGame() {
    localStorage.setItem("dungeonSave", JSON.stringify({
        player: player,
        game: game
    }));
}

function loadGame() {
    let s = localStorage.getItem("dungeonSave");
    if(!s) return;
    let data = JSON.parse(s);
    player = data.player;
    game = data.game;
}


/* ============================= */
/* UI HELPERS */
/* ============================= */

function log(t) {
    let box = document.getElementById("logBox");
    box.innerHTML += t + "<br>";
    box.scrollTop = box.scrollHeight;
}

function updateStats() {
    document.getElementById("playerStats").innerHTML =
        `HP: ${player.hp}/${player.maxHp}<br>DMG: ${player.dmg}`;
    if(game.currentEnemy)
        document.getElementById("enemyStats").innerHTML =
            `Враг HP: ${game.currentEnemy.hp}`;
    else
        document.getElementById("enemyStats").innerHTML = ``;
}


/* ============================= */
/* COMBAT */
/* ============================= */

function playerAttack() {
    if(!game.inCombat) return;
    let enemy = game.currentEnemy;

    if(Math.random() < player.miss) {
        log("<span style='color:yellow'>Промах!</span>");
        enemyTurn();
        return;
    }

    let damage = player.dmg;
    if(Math.random() < player.crit) {
        damage *= 2;
        log(`<span style="color:orange">Крит! ${damage} урона!</span>`);
    } else {
        log(`Вы ударили на ${damage} урона.`);
    }

    enemy.hp -= damage;
    if(enemy.hp <= 0) {
        winFight();
        return;
    }

    updateStats();
    enemyTurn();
}

function enemyTurn() {
    let enemy = game.currentEnemy;

    if(Math.random() < enemy.miss) {
        log("<span style='color:#6cf'>Враг промахнулся!</span>");
        return;
    }

    let dmg = enemy.dmg;
    if(Math.random() < enemy.crit) dmg *= 2;

    player.hp -= dmg;
    log(`<span style='color:red'>Враг ударил на ${dmg}!</span>`);

    if(player.hp <= 0) {
        loseGame();
        return;
    }
    updateStats();
}

function winFight() {
    log(`<span style='color:lightgreen'>Враг повержен!</span>`);
    game.inCombat = false;

    addItem({name:"Камень души"});
    addItem({name:"Золото"});
    addItem({name:"Малый предмет"});

    document.getElementById("nextRoomBtn").style.display="inline-block";
    updateStats();
}

function loseGame() {
    log("<span style='color:red'>Вы погибли!</span>");
}


/* ============================= */
/* ROOM HANDLING */
/* ============================= */

function enterRoom() {
    saveGame();
    updateStats();
    document.getElementById("logBox").innerHTML = "";

    let type = generateRoom();
    document.getElementById("roomImage").src = images[type];

    document.getElementById("nextRoomBtn").style.display="none";
    game.currentEnemy = null;
    game.inCombat = false;

    if(type === "enemy") {
        log("В комнате враг!");
        game.currentEnemy = generateEnemy();
        game.inCombat = true;
        updateStats();
    }
    if(type === "chest") log("Вы нашли сундук!");
    if(type === "light") log("Комната освещена.");
    if(type === "merchant") log("Тёмный торговец приветствует вас.");
    if(type === "trap") {
        log("Ловушка! Вы получите урон.");
        player.hp -= 10;
    }
    if(type === "empty") log("Пустая комната.");

    if(type !== "enemy")
        document.getElementById("nextRoomBtn").style.display="inline-block";

    updateStats();
}


/* ============================= */
/* BUTTON HANDLERS */
/* ============================= */

document.getElementById("attackBtn").onclick = playerAttack;
document.getElementById("defBtn").onclick = ()=>log("Вы защищаетесь!");
document.getElementById("dodgeBtn").onclick = ()=>log("Вы уклонились!");

document.getElementById("nextRoomBtn").onclick = ()=>{
    game.room++;
    if(game.room > 10) {
        game.room = 1;
        game.floor++;
        log(`<h2>Этаж ${game.floor}</h2>`);
    }
    enterRoom();
};

document.getElementById("inventoryBtn").onclick = ()=>{
    let panel = document.getElementById("inventoryPanel");
    panel.style.display = panel.style.display==="none" ? "block" : "none";
};


/* ============================= */
/* MENU → GAME TRANSITION */
/* ============================= */

document.getElementById("playBtn").onclick = ()=>{
    let door = document.getElementById("bigDoor");
    door.classList.add("door-open");

    setTimeout(()=>{
        document.getElementById("menuScreen").style.display="none";
        document.getElementById("gameScreen").style.display="block";
        enterRoom();
    },1100);
};

</script>

</body>
</html>
